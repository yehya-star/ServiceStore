// ===== الترجمات =====
const translations = {
  ar: {
    logo: "ServiceStore",
    home: "الرئيسية",
    services: "الخدمات",
    products: "المنتجات",
    booking: "احجز فني",
    admin: "لوحة التحكم",
    ourProducts: "منتجاتنا",
    bulbs: "لمبات - 50 جنيه",
    wires: "أسلاك - 30 جنيه",
    mixers: "خلاطات - 250 جنيه",
    cameras: "كاميرات - 800 جنيه",
    contact: "تواصل معنا: info@example.com",
    headline: "خدمات ومنتجات موثوقة لمنزلك ومكتبك",
    subtext: "سباكة، كهرباء، تكييف، وتركيب كاميرات — اطلب الفني المناسب أو اشتري المنتج المطلوب بسهولة.",
    bookNow: "احجز فني الآن",
    shopNow: "تسوق الآن",
    ourServices: "خدماتنا المميزة",
    plumbing: "سباكة",
    plumbingDesc: "صيانة التسريبات وتركيب الأدوات الصحية",
    electricity: "كهرباء",
    electricityDesc: "صيانة وأعمال تمديدات وتركيب لوحات",
    ac: "تكييف",
    acDesc: "تنظيف، تعبئة فريون وإصلاح أعطال",
    cctv: "كاميرات",
    cctvDesc: "تركيب كاميرات ومتابعة ما بعد البيع",
    about: "من نحن",
    aboutText: "نحن متجر إلكتروني متكامل يقدم خدمات فنيين والمنتجات اللازمة للمنزل والمكتب.",
    bookingTitle: "احجز فني الآن",
    bookingDesc: "اختر نوع الخدمة، التاريخ، والوقت المناسب.",
    chooseService: "اختر الخدمة:",
    chooseOption: "-- اختر --",
    plumbingOption: "سباكة",
    electricityOption: "كهرباء",
    acOption: "صيانة مكيفات",
    cctvOption: "كاميرات مراقبة",
    chooseDate: "التاريخ:",
    chooseTime: "الوقت:",
    chooseLocation: "حدد موقعك:",
    useMyLocation: "استخدم موقعي",
    confirmBooking: "تأكيد الحجز",
    adminPanel: "لوحة التحكم",
    adminDesc: "إدارة الطلبات والفنيين والمنتجات.",
    ordersTitle: "الطلبات الواردة"
  },
  en: {
    logo: "ServiceStore",
    home: "Home",
    services: "Services",
    products: "Products",
    booking: "Book a Technician",
    admin: "Admin Panel",
    ourProducts: "Our Products",
    bulbs: "Bulbs - 50 EGP",
    wires: "Wires - 30 EGP",
    mixers: "Mixers - 250 EGP",
    cameras: "Cameras - 800 EGP",
    contact: "Contact us: info@example.com",
    headline: "Reliable Services and Products for Your Home and Office",
    subtext: "Plumbing, Electricity, AC, and CCTV installation — Order the right technician or buy the product easily.",
    bookNow: "Book a Technician",
    shopNow: "Shop Now",
    ourServices: "Our Featured Services",
    plumbing: "Plumbing",
    plumbingDesc: "Leak repairs and sanitary installation",
    electricity: "Electricity",
    electricityDesc: "Electrical works and panel installation",
    ac: "AC",
    acDesc: "Cleaning, refilling, and repairing",
    cctv: "CCTV",
    cctvDesc: "Camera installation and after-sales service",
    about: "About Us",
    aboutText: "We are a complete online store providing technicians and products for home and office.",
    bookingTitle: "Book a Technician",
    bookingDesc: "Choose service, date, and time.",
    chooseService: "Choose Service:",
    chooseOption: "-- Select --",
    plumbingOption: "Plumbing",
    electricityOption: "Electricity",
    acOption: "AC Maintenance",
    cctvOption: "CCTV",
    chooseDate: "Date:",
    chooseTime: "Time:",
    chooseLocation: "Select Location:",
    useMyLocation: "Use My Location",
    confirmBooking: "Confirm Booking",
    adminPanel: "Admin Panel",
    adminDesc: "Manage orders, technicians, and products.",
    ordersTitle: "Incoming Orders"
  },
  fr: {
    logo: "ServiceStore",
    home: "Accueil",
    services: "Services",
    products: "Produits",
    booking: "Réserver un technicien",
    admin: "Panneau Admin",
    ourProducts: "Nos Produits",
    bulbs: "Ampoules - 50 EGP",
    wires: "Fils - 30 EGP",
    mixers: "Mixeurs - 250 EGP",
    cameras: "Caméras - 800 EGP",
    contact: "Contactez-nous: info@example.com",
    headline: "Services et produits fiables pour votre maison et bureau",
    subtext: "Plomberie, électricité, climatisation et installation de caméras — Commandez le bon technicien ou achetez le produit facilement.",
    bookNow: "Réserver un technicien",
    shopNow: "Acheter maintenant",
    ourServices: "Nos Services",
    plumbing: "Plomberie",
    plumbingDesc: "Réparation des fuites et installation sanitaire",
    electricity: "Électricité",
    electricityDesc: "Travaux électriques et installation de panneaux",
    ac: "Climatisation",
    acDesc: "Nettoyage, remplissage et réparation",
    cctv: "CCTV",
    cctvDesc: "Installation de caméras et service après-vente",
    about: "À propos",
    aboutText: "Nous sommes une boutique en ligne complète fournissant des techniciens et produits pour la maison et le bureau.",
    bookingTitle: "Réserver un technicien",
    bookingDesc: "Choisissez le service, la date et l'heure.",
    chooseService: "Choisissez le service:",
    chooseOption: "-- Sélectionner --",
    plumbingOption: "Plomberie",
    electricityOption: "Électricité",
    acOption: "Maintenance AC",
    cctvOption: "CCTV",
    chooseDate: "Date:",
    chooseTime: "Heure:",
    chooseLocation: "Sélectionner le lieu:",
    useMyLocation: "Utiliser ma position",
    confirmBooking: "Confirmer la réservation",
    adminPanel: "Panneau Admin",
    adminDesc: "Gérer les commandes, techniciens et produits.",
    ordersTitle: "Commandes entrantes"
  }
};

// ===== تطبيق الترجمات =====
function setLanguage(lang) {
  if (!translations[lang]) lang = "ar";
  document.querySelectorAll('[data-key]').forEach(el => {
    const key = el.getAttribute('data-key');
    if(translations[lang][key]) el.textContent = translations[lang][key];
  });
  document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
}

// ===== عند تحميل الصفحة =====
document.addEventListener('DOMContentLoaded', function() {
  const langSwitcher = document.getElementById('lang-switcher');

  // لغة افتراضية أو مخزنة
  let currentLang = localStorage.getItem('site_lang') || 'ar';
  setLanguage(currentLang);
  langSwitcher.value = currentLang;

  // تغيير اللغة فورًا عند اختيار المستخدم
  langSwitcher.addEventListener('change', function() {
    currentLang = this.value;
    localStorage.setItem('site_lang', currentLang);
    setLanguage(currentLang);
  });

  // عرض السنة الحالية
  document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());
});

// public/app.js
// ----- Socket.io client -----
const socket = io(); // يفترض أنك ستشغّل socket.io script في الصفحة

// ===== تغيير النصوص عن طريق data-key =====
function setLanguage(lang) {
  if (!translations[lang]) lang = 'ar';
  document.querySelectorAll('[data-key]').forEach(el => {
    const key = el.getAttribute('data-key');
    if (translations[lang][key]) el.textContent = translations[lang][key];
  });
  document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';
}

// ===== عند تحميل الصفحة =====
document.addEventListener('DOMContentLoaded', function(){
  // language switcher
  const langSwitchers = document.querySelectorAll('#lang-switcher');
  let currentLang = localStorage.getItem('site_lang') || 'ar';
  setLanguage(currentLang);
  langSwitchers.forEach(sel => sel.value = currentLang);
  langSwitchers.forEach(sel => {
    sel.addEventListener('change', function(){
      currentLang = this.value;
      localStorage.setItem('site_lang', currentLang);
      setLanguage(currentLang);
    });
  });

  // السنة في الفوتر
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // setup add-to-cart buttons: emit socket event then redirect to admin.html
  document.querySelectorAll('.btn-primary.btn-sm').forEach(btn => {
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const card = this.closest('.card');
      const productNameEl = card && card.querySelector('.card-title');
      const productName = productNameEl ? productNameEl.textContent.trim() : 'Unknown Product';
      const priceEl = card && card.querySelector('.fw-bold');
      const priceText = priceEl ? priceEl.textContent.trim() : '';
      // حاول استخراج رقم السعر فقط
      const price = Number((priceText.match(/(\d+)/) || [0])[0]) || 0;

      const order = {
        productName,
        price,
        qty: 1,
        fromPage: window.location.pathname,
        time: new Date().toISOString()
      };

      // إرسال عبر Socket.io
      if (socket && socket.connected) {
        socket.emit('new-order', order);
      } else {
        // إذا Socket غير متصل، قم بعمل POST احتياطي (اختياري)
        fetch('/api/orders-backup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(order) }).catch(()=>{});
      }

      // حفظ مؤقت في sessionStorage (اختياري)
      sessionStorage.setItem('lastOrder', JSON.stringify(order));

      // تحويل إلى admin.html
      window.location.href = 'admin.html';
    });
  });
});

// ===== الخريطة =====
const map = L.map('map').setView([30.0444, 31.2357], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors',
  maxZoom: 19
}).addTo(map);

const marker = L.marker([30.0444, 31.2357], { draggable: true }).addTo(map);

function updateLatLng(lat, lng) {
  document.getElementById('latitude').value = lat;
  document.getElementById('longitude').value = lng;
}
updateLatLng(30.0444, 31.2357);

marker.on('dragend', function () {
  const { lat, lng } = marker.getLatLng();
  updateLatLng(lat, lng);
});

document.getElementById('useLocation').addEventListener('click', () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat, lng], 15);
      marker.setLatLng([lat, lng]);
      updateLatLng(lat, lng);
    }, () => {
      alert("تعذر الحصول على موقعك");
    });
  } else {
    alert("المتصفح لا يدعم تحديد الموقع");
  }
});

// ===== تأكيد الحجز =====
document.getElementById('bookingForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const service = document.getElementById('service').value;
  const date = document.getElementById('date').value;
  const time = document.getElementById('time').value;
  const lat = document.getElementById('latitude').value;
  const lng = document.getElementById('longitude').value;

  alert(`✅ تم الحجز:\nالخدمة: ${service}\nالتاريخ: ${date}\nالوقت: ${time}\nالموقع: ${lat}, ${lng}`);
});



